# Notes for Project PR7525952 - Vec Definition

** 10/7/2015 2:59:55 PM **

http://www.cbr.ugs.com/cgi-bin/tac_pr.pl?form=faults.html&entry=7525952&employee=emp&closed=Open+Non-OQ&days=7+days&display=List&db=rpt7_tac%3A%3Aus_db

D:\Scratch\PR7525952-VectorDefinition\Block_dwg1.prt

Steps to reproduce:
1.	Launch NX
2.	Open Block_dwg1.prt
3.	RMB on left view -> Projected View -> Hinge Line -> Vector Option -> Defined
4.	Specify Vector -> Two Points
5.	Select top left and bottom right points in left view
6.	Parent View -> Select View select right view
7.	Place view and notice it is not at a diagonal

What is the intended behaviour? Should the vector option field reset once the new view is selected?

** 10/13/2015 9:08:06 AM **

Rick looked at this briefly and noted these lines @ line 1025 of Drawing_HingeLineData.cxx:
    // Map the vector direction in drawing space.
    MTX3_vec_multiply(&hingeLineVector, &m_parentViewMatrix, &hingeLineVector);
    VEC3_vec2(&hingeLineVector, &hingeLineVector2d);
    
The email:
    Hi Will,

    This same problem will happen if you pick another base view that has a different orientation than the original base
    view that you were creating the projected view off of, i.e., it doesnâ€™t have to be a section view.

    It looks like the hingeLineVector is getting incorrectly calculated in 
    UGS::Drawing::HingeLineData::ComputeDefinedVectorOnDrawing on these lines:

                    // Map the vector direction in drawing space.
                    MTX3_vec_multiply(&hingeLineVector, &m_parentViewMatrix, &hingeLineVector);
                    VEC3_vec2(&hingeLineVector, &hingeLineVector2d);

    Seems like when the parent view is changed, the hingeLineVector is already in drawing space, and the transform 
    is unnecessary.
    We may have to brainstorm a solution.

    Thanks,
    Rick

There are two slightly different workflows that should result in the same thing but don't.
The first is the pr scenario.
The second is this (start on step 3. of the pr scenario):
    3.  Projected View -> Parent View -> Select View -> select the right view
    4.  Hinge Line -> Vector Option -> Defined
    5.  Specify Vector -> Two Points
    6.	Select top left and bottom right points in left view
    7.  Place view and notice that the behvior is different (and seems correct)
    
I'm going to investigate the different between these two workflows.

Workflow 1:
    @ line 995: hingeLineVector (Vector3) is (0.707, -0.707, 0.000) after call to GetVectorDir()
    @ line 1025: hingeLineVector (Vector3) is (0.707, -0.707, 0.000)
    @ line 1026: hingeLineVector (Vector3) is (0.000, -0.707, 0.707) after call to MTX3_vec_multiply()
                 hingeLineVector2d (Vector2) is (0.000, 0.000)
    @ line 1028: hingeLineVector (Vector3) is (0.000, -0.707, 0.707) after call to VEC3_vec2()
                 hingeLineVector2d (Vector2) is (0.000, -0.707)
    @ line 1033: hingeLineVector2d (Vector2) is (0.000, -1.000) after call to VEC2_unitize()
    @ line 1047: returns (Vector2) (0.000, -1.000)

Workflow 2:
    @ line 995: hingeLineVector (Vector3) is (0.000, -0.707, -0.707) after call to GetVectorDir()
    @ line 1025: hingeLineVector (Vector3) is (0.000, -0.707, -0.707)
    @ line 1026: hingeLineVector (Vector3) is (0.707, -0.707, 0.000) after call to MTX3_vec_multiply()
                 hingeLineVector2d (Vector2) is (0.000, 0.000)
    @ line 1028: hingeLineVector (Vector3) is (0.707, -0.707, 0.000) after call to VEC3_vec2()
                 hingeLineVector2d (Vector2) is (0.707, -0.707)
    @ line 1033: hingeLineVector2d (Vector2) is (0.707, -0.707) after call to VEC2_unitize()
    @ line 1047: returns (Vector2) (0.707, -0.707)

The key difference is what GetVectorDir() returns initially. So I need to figure out why this is different
in these two cases.
    It turns out that the m_definedVectorTag is just different. So the root cause of this difference is somewhere
    else.
    
m_definedVectorTag
    54691, 52184 

Full Print for workflow 1 m_definedVectorTag:
    Object &000007FFF796ED20 is an instance of 'Direction UGS::DIRR
    isa                                      3772
    om_object_flags                          2
    **om_object_flags                        has_a_tag
    om_storage_flags                         0
    root_object                              &000007FFFB175188 (UGS::OM::RootObject)
    tag                                      TAG 54691 (0xd5a3) (UGS::DIRR)
    major_version                            12
    minor_version                            12
    next                                     &000007FFFA447B20 (UGS::DIRR)
    prev                                     &000007FFF796EC18 (UGS::DIRR)
    om_opt_att_values                        NULL
    entity_type                              217
    entity_subtype                           0
    status                                   2
    **status                                 condemned
    reference_count                          0
    display_status                           4194304
    **display_status                         density:0|font:0
    color                                    0
    layer                                    0
    m_ghostParms                             (untyped) NULL
    m_isInterModule                          0
    direction[0]                             0.70710678118654757
    direction[1]                             -0.70710678118654757
    direction[2]                             0
    point[0]                                 0
    point[1]                                 100
    point[2]                                 100
    parms                                    NULL

Full Print for workflow 2 m_definedVectorTag:
    Object &000007FFF8667628 is an instance of 'Direction UGS::DIRR
    isa                                      3772
    om_object_flags                          2
    **om_object_flags                        has_a_tag
    om_storage_flags                         0
    root_object                              &000007FFFB175188 (UGS::OM::RootObject)
    tag                                      TAG 52184 (0xcbd8) (UGS::DIRR)
    major_version                            12
    minor_version                            12
    next                                     &000007FFF74C7270 (UGS::DIRR)
    prev                                     &000007FFF78E7D60 (UGS::DIRR)
    om_opt_att_values                        NULL
    entity_type                              217
    entity_subtype                           0
    status                                   2
    **status                                 condemned
    reference_count                          0
    display_status                           4194304
    **display_status                         density:0|font:0
    color                                    0
    layer                                    0
    m_ghostParms                             (untyped) NULL
    m_isInterModule                          0
    direction[0]                             0
    direction[1]                             -0.70710678118654757
    direction[2]                             -0.70710678118654757
    point[0]                                 0
    point[1]                                 100
    point[2]                                 496.55270602706025
    parms                                    NULL

    
** 10/13/2015 1:42:35 PM **

Commenting out line 1025 of Drawing_HingeLineData.cxx did have an effect, but it is certainly not the correct
change. Specifically, it seemed to fix the preview but it did not fix the placement.

As another interesting note, doing an undo then a redo immediately after placing a view using workflow 1 results
in the same view as produced by workflow 2.

Down the callstack starting @ line 560 of DrawingUI_UICompProjectedView.cxx is where the view gets shifted down
and placed in workflow 1.
Investigating this callstack:
    enter update() @ line 1864 of DrawingUI_UICompViewGlue.cxx
    enter 'else if (IsChanged(GetPlacementComponent()))' block @ line 1907
    call 'this->ask_framework()-PerformApply(this);' @ line 2023
    